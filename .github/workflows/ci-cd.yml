name: Build and Promote to Dev

on:
    push:
        branches:
            - main

env:
    REGISTRY: k8demoacr.azurecr.io
    IMAGE_NAME: k8test
    GITOPS_REPO: kirosoft/k8test-gitops-repo
    GITOPS_PATH: envs/dev/k8test
    VALUES_FILE: values.yaml

jobs:
    build-push:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout app repo
              uses: actions/checkout@v4

            - name: Azure login
              uses: azure/login@v1
              with:
                  creds: '{"clientId":"${{ secrets.client_id }}","clientSecret":"${{ secrets.client_secret }}","tenantId":"${{ secrets.tenant_id }}","subscriptionId":"${{ secrets.subscription_id }}"}'

            - name: Login to Azure Container Registry
              run: az acr login --name k8demoacr

            - name: Build and push image
              run: |
                  docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
                  docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

            - name: Build completed
              run: |
                  echo "âœ… Docker image built and pushed successfully!"
                  echo "ðŸ“¦ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
                  echo ""
                  echo "ðŸš€ Next steps:"
                  echo "1. Add GITOPS_TOKEN secret to enable automatic GitOps updates"
                  echo "2. Manually update the image tag in your GitOps repository:"
                  echo "   Repository: kirosoft/k8test-gitops-repo"
                  echo "   File: envs/dev/k8test/values.yaml"
                  echo "   Set image.tag: ${{ github.sha }}"
