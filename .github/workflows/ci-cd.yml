name: Build and Promote to Dev

on:
    push:
        branches:
            - main

env:
    REGISTRY: k8demoacr.azurecr.io
    IMAGE_NAME: k8test
    GITOPS_REPO: kirosoft/k8test-gitops-repo
    GITOPS_PATH: envs/dev/k8test
    VALUES_FILE: values.yaml

jobs:
    build-push:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout app repo
              uses: actions/checkout@v4

            - name: Azure login
              uses: azure/login@v1
              with:
                  creds: '{"clientId":"${{ secrets.client_id }}","clientSecret":"${{ secrets.client_secret }}","tenantId":"${{ secrets.tenant_id }}","subscriptionId":"${{ secrets.subscription_id }}"}'

            - name: Login to Azure Container Registry
              run: az acr login --name k8demoacr

            - name: Build and push image
              run: |
                  docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
                  docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

            - name: Update gitops values
              uses: actions/checkout@v4
              with:
                  repository: kirosoft/k8test-gitops-repo
                  token: ${{ secrets.GITOPS_TOKEN }}
                  path: gitops-repo

            - name: Install yq
              run: |
                  sudo wget -O /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
                  sudo chmod +x /usr/local/bin/yq

            - name: Set image tag in ArgoCD application
              run: |
                  cd gitops-repo/${{ env.GITOPS_PATH }}
                  yq e -i '(.spec.source.helm.parameters[] | select(.name == "image.tag")).value = "${{ github.sha }}"' argo-app-k8test-dev.yaml
                  git config user.name "github-actions"
                  git config user.email "actions@github.com"
                  git add argo-app-k8test-dev.yaml
                  git commit -m "ci: update image tag to ${{ github.sha }}"
                  git push origin HEAD:main

            - name: Deployment completed
              run: |
                  echo "âœ… Docker image built and pushed successfully!"
                  echo "ðŸ“¦ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
                  echo "âœ… GitOps repository updated automatically!"
                  echo "ðŸš€ Argo CD will deploy the new image to your cluster"
